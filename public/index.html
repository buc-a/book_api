<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫–Ω–∏–≥</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
<div class="container py-4">
  <h1>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫–Ω–∏–≥</h1>
  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–∏–≥–∏ -->
  <form id="book-form" class="row g-2 mb-4">
    <input type="hidden" id="book-id">
    <div class="col-sm-3">
      <input required class="form-control" id="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏">
    </div>
    <div class="col-sm-3">
      <input required class="form-control" id="author" placeholder="–ê–≤—Ç–æ—Ä">
    </div>
    <div class="col-sm-2">
      <input class="form-control" id="year" type="number" placeholder="–ì–æ–¥ –∏–∑–¥–∞–Ω–∏—è">
    </div>
    <div class="col-sm-2">
      <input class="form-control" id="genre" placeholder="–ñ–∞–Ω—Ä">
    </div>
    <div class="col-sm-2 d-grid gap-2">
      <button type="submit" class="btn btn-primary" id="save-btn">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button type="button" class="btn btn-secondary d-none" id="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </form>

  <!-- –°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ -->
  <table class="table table-hover">
    <thead>
      <tr>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>–ê–≤—Ç–æ—Ä</th>
        <th>–ì–æ–¥</th>
        <th>–ñ–∞–Ω—Ä</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody id="books-list"></tbody>
  </table>
</div>

<script>
const API = '/api/books'; // –¥–ª—è Railway –æ—Å—Ç–∞–≤—å—Ç–µ, –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ —Ç–æ–∂–µ
const booksList = document.getElementById('books-list');
const bookForm = document.getElementById('book-form');
const saveBtn = document.getElementById('save-btn');
const cancelBtn = document.getElementById('cancel-btn');

function renderBooks(books) {
  booksList.innerHTML = '';
  books.forEach(book => {
    booksList.innerHTML += `
      <tr>
        <td>${book.title || ''}</td>
        <td>${book.author || ''}</td>
        <td>${book.year || ''}</td>
        <td>${book.genre || ''}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick='editBook("${book._id}")'>‚úèÔ∏è</button>
          <button class="btn btn-sm btn-danger" onclick='deleteBook("${book._id}")'>üóëÔ∏è</button>
        </td>
      </tr>
    `;
  });
}

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–Ω–∏–≥–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
async function fetchBooks() {
  const res = await fetch(API);
  const books = await res.json();
  renderBooks(books);
}
fetchBooks();

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã (–¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–Ω–∏–≥—É)
bookForm.onsubmit = async e => {
  e.preventDefault();
  const book = {
    title: bookForm.title.value.trim(),
    author: bookForm.author.value.trim(),
    year: bookForm.year.value ? Number(bookForm.year.value) : undefined,
    genre: bookForm.genre.value.trim()
  };
  const id = bookForm['book-id'].value;
  if (id) {
    // –û–±–Ω–æ–≤–∏—Ç—å
    await fetch(API + '/' + id, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(book)
    });
  } else {
    // –î–æ–±–∞–≤–∏—Ç—å
    await fetch(API, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(book)
    });
  }
  bookForm.reset();
  saveBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å';
  cancelBtn.classList.add('d-none');
  fetchBooks();
};

// –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
cancelBtn.onclick = e => {
  bookForm.reset();
  cancelBtn.classList.add('d-none');
  saveBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å';
};

// –£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É
async function deleteBook(id) {
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É?')) return;
  await fetch(API + '/' + id, { method: 'DELETE' });
  fetchBooks();
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É
async function editBook(id) {
  const res = await fetch(API + '/' + id);
  const book = await res.json();
  bookForm.title.value = book.title || '';
  bookForm.author.value = book.author || '';
  bookForm.year.value = book.year || '';
  bookForm.genre.value = book.genre || '';
  bookForm['book-id'].value = id;
  saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
  cancelBtn.classList.remove('d-none');
}
</script>
</body>
</html>
